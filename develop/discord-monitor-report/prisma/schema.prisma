// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ユーザー（担当マスタ）
model User {
  id           Int      @id @default(autoincrement()) @map("user_id")
  name         String   @db.VarChar(255)
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  role         UserRole @default(STAFF)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // リレーション
  dailyReports DailyReport[]
  comments     Comment[]

  @@map("users")
}

// ユーザー権限
enum UserRole {
  STAFF   // 担当者
  MANAGER // 上長
}

// Discordサーバー（サーバーマスタ）
model DiscordServer {
  id          Int      @id @default(autoincrement()) @map("server_id")
  serverName  String   @map("server_name") @db.VarChar(255)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // リレーション
  monitoringRecords MonitoringRecord[]

  @@map("discord_servers")
}

// 日報
model DailyReport {
  id         Int      @id @default(autoincrement()) @map("report_id")
  userId     Int      @map("user_id")
  reportDate DateTime @map("report_date") @db.Date
  problem    String?  @db.Text // 課題・相談
  plan       String?  @db.Text // 明日の予定
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // リレーション
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  monitoringRecords MonitoringRecord[]
  comments          Comment[]

  @@index([userId])
  @@index([reportDate])
  @@map("daily_reports")
}

// 監視記録
model MonitoringRecord {
  id                Int      @id @default(autoincrement()) @map("record_id")
  reportId          Int      @map("report_id")
  serverId          Int      @map("server_id")
  monitoringContent String   @map("monitoring_content") @db.Text
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // リレーション
  dailyReport   DailyReport   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  discordServer DiscordServer @relation(fields: [serverId], references: [id])

  @@index([reportId])
  @@index([serverId])
  @@map("monitoring_records")
}

// コメント
model Comment {
  id          Int          @id @default(autoincrement()) @map("comment_id")
  reportId    Int          @map("report_id")
  userId      Int          @map("user_id") // コメント者
  targetField CommentTarget @map("target_field") // 対象項目（Problem/Plan）
  commentText String       @map("comment_text") @db.Text
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // リレーション
  dailyReport DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id])

  @@index([reportId])
  @@index([userId])
  @@map("comments")
}

// コメント対象項目
enum CommentTarget {
  PROBLEM // 課題・相談
  PLAN    // 明日の予定
}
