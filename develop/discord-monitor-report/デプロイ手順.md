# Discord監視日報システム デプロイ手順

## 1. 前提条件

### 必要なツール
- Google Cloud SDK (gcloud CLI)
- Docker
- Make
- Node.js 20以上

### Google Cloud プロジェクト情報
- **Project ID:** `discord-management-482906`
- **Service Name:** `discord-monitor-report`
- **Region:** `asia-northeast1` (東京)

---

## 2. 初回セットアップ

### 2.1 Google Cloud SDK のインストール
```bash
# macOS (Homebrew)
brew install --cask google-cloud-sdk

# Windows
# https://cloud.google.com/sdk/docs/install からインストーラーをダウンロード

# Linux
curl https://sdk.cloud.google.com | bash
```

### 2.2 Google Cloud 認証
```bash
# Google Cloud にログイン
gcloud auth login

# プロジェクトとDocker認証の設定
make setup-gcloud
```

### 2.3 必要なAPIの有効化
```bash
gcloud services enable run.googleapis.com
gcloud services enable containerregistry.googleapis.com
gcloud services enable cloudbuild.googleapis.com
```

### 2.4 環境変数の設定
`.env` ファイルを作成し、以下の環境変数を設定：

```env
DATABASE_URL=postgresql://user:password@host:5432/dbname
JWT_SECRET=your-secret-key-here
NEXT_PUBLIC_API_URL=https://your-cloud-run-url.a.run.app
```

---

## 3. Makefileコマンド一覧

### 開発コマンド
```bash
make help              # コマンド一覧を表示
make install           # 依存関係をインストール
make dev               # 開発サーバー起動
make build             # 本番ビルド
make test              # テスト実行
make lint              # Linter実行
make tsc               # TypeScript型チェック
make check             # lint + tsc + test を実行
```

### Prismaコマンド
```bash
make prisma-generate   # Prisma Clientを生成
make prisma-migrate    # マイグレーション実行
make prisma-push       # スキーマをDBにプッシュ
make prisma-studio     # Prisma Studio起動
```

### Dockerコマンド
```bash
make docker-build      # Dockerイメージをビルド
make docker-run        # Dockerコンテナをローカル実行
make docker-push       # DockerイメージをGCRにプッシュ
```

### デプロイコマンド
```bash
make deploy            # Cloud Runにデプロイ（ビルド+プッシュ+デプロイ）
make deploy-build      # Dockerイメージのビルド+プッシュのみ
make deploy-url        # デプロイされたURLを表示
```

### 運用コマンド
```bash
make logs              # 最新50件のログを表示
make logs-tail         # ログをリアルタイム監視
make rollback          # 前バージョンにロールバック
make delete            # Cloud Runサービスを削除
```

---

## 4. デプロイ手順（手動デプロイ）

### 4.1 ローカルでテスト
```bash
# 依存関係をインストール
make install

# Linter, TypeScript, テストを実行
make check

# ローカルで開発サーバーを起動して動作確認
make dev
```

### 4.2 Dockerイメージをビルド
```bash
# Dockerイメージをビルド
make docker-build

# ローカルでDockerコンテナを起動して動作確認
make docker-run
```

### 4.3 Cloud Runにデプロイ
```bash
# ビルド、プッシュ、デプロイを一括実行
make deploy
```

デプロイ後、URLが表示されます：
```
Deployment URL:
https://discord-monitor-report-xxxxxxxxxx-an.a.run.app
```

### 4.4 デプロイ確認
```bash
# デプロイされたURLを確認
make deploy-url

# ログを確認
make logs
```

---

## 5. CI/CDによる自動デプロイ（GitHub Actions）

### 5.1 GitHub Secretsの設定

GitHubリポジトリの Settings > Secrets and variables > Actions で以下を設定：

| Secret名 | 説明 |
|---------|------|
| `WIF_PROVIDER` | Workload Identity連携のプロバイダー |
| `WIF_SERVICE_ACCOUNT` | サービスアカウントのメールアドレス |
| `DATABASE_URL` | データベース接続文字列 |
| `JWT_SECRET` | JWT秘密鍵 |
| `NEXT_PUBLIC_API_URL` | API ベースURL |

### 5.2 Workload Identity連携の設定

```bash
# サービスアカウント作成
gcloud iam service-accounts create github-actions \
  --display-name="GitHub Actions" \
  --project=discord-management-482906

# 必要な権限を付与
gcloud projects add-iam-policy-binding discord-management-482906 \
  --member="serviceAccount:github-actions@discord-management-482906.iam.gserviceaccount.com" \
  --role="roles/run.admin"

gcloud projects add-iam-policy-binding discord-management-482906 \
  --member="serviceAccount:github-actions@discord-management-482906.iam.gserviceaccount.com" \
  --role="roles/storage.admin"

gcloud projects add-iam-policy-binding discord-management-482906 \
  --member="serviceAccount:github-actions@discord-management-482906.iam.gserviceaccount.com" \
  --role="roles/iam.serviceAccountUser"

# Workload Identity Poolの作成
gcloud iam workload-identity-pools create github \
  --location=global \
  --display-name="GitHub Actions Pool" \
  --project=discord-management-482906

# Workload Identity Providerの作成
gcloud iam workload-identity-pools providers create-oidc github-provider \
  --location=global \
  --workload-identity-pool=github \
  --issuer-uri="https://token.actions.githubusercontent.com" \
  --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.repository=assertion.repository" \
  --project=discord-management-482906

# サービスアカウントとの紐付け
gcloud iam service-accounts add-iam-policy-binding \
  github-actions@discord-management-482906.iam.gserviceaccount.com \
  --role="roles/iam.workloadIdentityUser" \
  --member="principalSet://iam.googleapis.com/projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/github/attribute.repository/YOUR_GITHUB_USERNAME/discord-monitor-report" \
  --project=discord-management-482906
```

**注意:** `PROJECT_NUMBER` と `YOUR_GITHUB_USERNAME` は実際の値に置き換えてください。

### 5.3 自動デプロイフロー

`.github/workflows/deploy.yml` が設定されているため、以下のフローで自動デプロイされます：

1. **Pull Request作成時**
   - Lint, TypeScript型チェック, テストを実行
   - デプロイは実行しない

2. **mainブランチへのPush時**
   - Lint, TypeScript型チェック, テストを実行
   - テストが成功したらDockerイメージをビルド
   - GCR（Google Container Registry）にプッシュ
   - Cloud Runにデプロイ

---

## 6. データベースマイグレーション

### 6.1 開発環境でマイグレーション作成
```bash
# マイグレーションファイルを作成
make prisma-migrate
```

### 6.2 本番環境でマイグレーション適用

Cloud Runのデプロイ時に自動的にPrismaスキーマが適用されますが、手動で実行する場合：

```bash
# Cloud Run上でマイグレーションを実行
gcloud run jobs create migration-job \
  --image gcr.io/discord-management-482906/discord-monitor-report:latest \
  --set-env-vars DATABASE_URL=${DATABASE_URL} \
  --region asia-northeast1 \
  --command="npx" \
  --args="prisma,migrate,deploy" \
  --project discord-management-482906

gcloud run jobs execute migration-job \
  --region asia-northeast1 \
  --project discord-management-482906
```

---

## 7. 環境変数の更新

Cloud Runにデプロイ済みのサービスの環境変数を更新：

```bash
gcloud run services update discord-monitor-report \
  --set-env-vars DATABASE_URL=new-value \
  --region asia-northeast1 \
  --project discord-management-482906
```

---

## 8. トラブルシューティング

### デプロイが失敗する場合

```bash
# ログを確認
make logs

# ビルドログを確認
gcloud builds list --project discord-management-482906
gcloud builds log BUILD_ID --project discord-management-482906
```

### コンテナが起動しない場合

```bash
# ローカルでDockerイメージをビルドして動作確認
make docker-build
make docker-run

# ログを確認
docker logs CONTAINER_ID
```

### データベース接続エラー

```bash
# 環境変数が正しく設定されているか確認
gcloud run services describe discord-monitor-report \
  --region asia-northeast1 \
  --project discord-management-482906 \
  --format="yaml(spec.template.spec.containers[0].env)"
```

---

## 9. コスト最適化

### Cloud Runの設定

- **min-instances: 0** - リクエストがない時はインスタンスを停止
- **max-instances: 10** - 最大10インスタンスまでスケール
- **memory: 512Mi** - メモリ512MB
- **cpu: 1** - CPU 1コア
- **timeout: 60** - タイムアウト60秒

### コスト確認
```bash
# 請求情報を確認
gcloud beta billing accounts list
gcloud beta billing projects describe discord-management-482906
```

---

## 10. セキュリティベストプラクティス

- ✅ 環境変数は Secret Manager に保存（推奨）
- ✅ サービスアカウントは最小権限の原則
- ✅ 本番環境では `--allow-unauthenticated` を外して認証必須に
- ✅ データベースは Cloud SQL Private IP で接続
- ✅ HTTPS通信のみ許可
- ✅ Cloud Armorでレート制限を設定

---

**バージョン:** 1.0.0
**作成日:** 2025-12-31
**最終更新日:** 2025-12-31
